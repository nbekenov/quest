# Adaptation of the https://developer.hashicorp.com/terraform/tutorials/automation/github-actions workflow
Name: TerraformMainBranch
SchemaVersion: "1.0"

Triggers:
  - Type: Push
    Branches:
      - master

Actions:
  Build:
    Actions:
      terraform-bootstrap:
        Compute:
          Type: EC2
        Identifier: aws/build@v1
        Inputs:
          Sources:
            - WorkflowSource
        Environment:
          Name: dev
          Connections:
            - Role: Main-Branch-Infrastructure
              Name: "dev"
        Configuration:
          # Container:
          #   Registry: registry
          #   Image: image
          Steps:
            - Run: export TF_VERSION=1.3.7 && wget -O terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
            - Run: unzip terraform.zip && rm terraform.zip && mv terraform /usr/bin/terraform && chmod +x /usr/bin/terraform
            - Run: cd iac/bootstrap
            - Run: terraform fmt -check -no-color
            - Run: terraform init -no-color
            - Run: terraform validate -no-color
            - Run: terraform plan -no-color -input=false
            - Run: terraform apply -auto-approve -no-color -input=false
      build_backend:
        Compute:
          Type: EC2
        Identifier: aws/build@v1
        Inputs:
          Sources:
            - WorkflowSource
        Environment:
          Name: dev
          Connections:
            - Role: Main-Branch-Infrastructure
              Name: "dev"
        Configuration: 
          Steps:
            - Run: npm ci
            - Run: npx npm test
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: backend
            IncludePaths:
              - "**/*"
            SuccessCriteria:
              PassRate: 100
              Vulnerabilities:
                Severity: CRITICAL
          Artifacts:
            - Name: backend
              Files:
                - "**/*"
  Create-Infra:
    DependsOn:
    - Build
    Actions:
      create-infra:
        Compute:
          Type: EC2
        Identifier: aws/build@v1
        Inputs:
          Sources:
            - WorkflowSource
        Environment:
          Name: dev
          Connections:
            - Role: Main-Branch-Infrastructure
              Name: "dev"
        Configuration:
          Steps:
            - Run: scripts/terraform_install.sh
            - Run: scripts/terraform_plan.sh iac/app_infra dev
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: infra
            IncludePaths:
              - "iac/app_infra/reports/*"
            SuccessCriteria:
              PassRate: 100
              Vulnerabilities:
                Severity: CRITICAL